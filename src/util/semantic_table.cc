#include "semantic_table.h"

#include <fstream>
#include <iostream>
#include <jsoncpp/json/json.h>
#include <Eigen/Core>

#include "util/string.h"

namespace sensemap {

unsigned char adepallete[765] = {
  0, 0, 0,               // 0
  255, 165, 0,           // 1
  255, 20, 147,          // 2
  6, 230, 230,           // 3
  128,64,128,            // 4
  153,153,153,           // 5
  70, 130, 180,          // 6
  93,71,139,             // 7
  148,0,211,             // 8
  139,115,85,            // 9
  119,11,32,             // 10
  250,70,70,             // 11
  250,218,141,           // 12
  25,25,112,             // 13
  255,230,0,             // 14
  240,255,240,           // 15
  255,6,82,              // 16
  255,106,106,           // 17
  107,142,35,            // 18
  255,114,86,            // 19
  204,70,3,              // 20
  20,60,255,             // 21
  255,187,255,           // 22
  255,6,51,              // 23
  11,102,255,            // 24
  0,191,255,             // 25
  162,205,90,            // 26
  255,7,71,              // 27
  250,128,10,            // 28
  255,9,92,              // 29
  112,9,255,             // 30
  8,255,214,             // 31
  7,255,224,             // 32
  255,184,6,             // 33
  10,255,71,             // 34
  255,41,10,             // 35
  7,255,255,             // 36
  224,255,8,             // 37
  102,8,255,             // 38
  255,61,6,              // 39
  255,194,7,             // 40
  255,122,8,             // 41
  0,255,20,              // 42
  255,8,41,              // 43
  255,5,153,             // 44
  6,51,255,              // 45
  235,12,255,            // 46
  160,150,20,            // 47
  0,163,255,             // 48
  140,140,140,           // 49
  250,10,15,             // 50
  255,255,255,           // 51
  31,255,0,              // 52
  255,31,0,              // 53
  255,224,0,             // 54
  153,255,0,             // 55
  0,0,255,               // 56
  255,71,0,              // 57
  0,235,255,             // 58
  0,173,255,             // 59
  31,0,255,              // 60
  11,200,200,            // 61
  255,82,0,              // 62
  0,255,245,             // 63
  0,61,255,              // 64
  0,255,112,             // 65
  0,255,133,             // 66
  255,0,0,               // 67
  255,163,0,             // 68
  255,102,0,             // 69
  194,255,0,             // 70
  0,143,255,             // 71
  51,255,0,              // 72
  0,82,255,              // 73
  0,255,41,              // 74
  0,255,173,             // 75
  10,0,255,              // 76
  173,255,0,             // 77
  0,255,153,             // 78
  255,92,0,              // 79
  255,0,255,             // 80
  255,0,245,             // 81
  255,0,102,             // 82
  255,173,0,             // 83
  255,0,20,              // 84
  255,184,184,           // 85
  0,31,255,              // 86
  0,255,61,              // 87
  0,71,255,              // 88
  255,0,204,             // 89
  0,255,194,             // 90
  0,255,82,              // 91
  0,10,255,              // 92
  0,112,255,             // 93
  51,0,255,              // 94
  0,194,255,             // 95
  0,122,255,             // 96
  0,255,163,             // 97
  255,153,0,             // 98
  0,255,10,              // 99
  255,112,0,             // 100
  143,255,0,             // 101
  82,0,255,              // 102
  163,255,0,             // 103
  255,235,0,             // 104
  8,184,170,             // 105
  133,0,255,             // 106
  0,255,92,              // 107
  184,0,255,             // 108
  255,0,31,              // 109
  0,184,255,             // 110
  0,214,255,             // 111
  255,0,112,             // 112
  92,255,0,              // 113
  0,224,255,             // 114
  112,224,255,           // 115
  70,184,160,            // 116
  163,0,255,             // 117
  153,0,255,             // 118
  71,255,0,              // 119
  255,0,163,             // 120
  255,204,0,             // 121
  255,0,143,             // 122
  0,255,235,             // 123
  133,255,0,             // 124
  255,0,235,             // 125
  245,0,255,             // 126
  255,0,122,             // 127
  255,245,0,             // 128
  10,190,212,            // 129
  214,255,0,             // 130
  0,204,255,             // 131
  20,0,255,              // 132
  255,255,0,             // 133
  0,153,255,             // 134
  0,41,255,              // 135
  0,255,204,             // 136
//   41,0,255,              // 137
  250,218,141,           // 137
  41,255,0,              // 138
  173,0,255,             // 139
  0,245,255,             // 140
  71,0,255,              // 141
  122,0,255,             // 142
  0,255,184,             // 143
  0,92,255,              // 144
  184,255,0,             // 145
  0,133,255,             // 146
  255,214,0,             // 147
  25,194,194,            // 148
  102,255,0,             // 149
  92,0,255               // 150
};

void LoadSemanticColorTable(const char* filepath) {
    std::ifstream file(filepath, std::ios::in);
    if (!file.is_open()) {
        std::cout << "Error opening file " << filepath << std::endl;
        return;
    }

    Json::Reader reader;
    Json::Value root;

    if (reader.parse(file, root)) {
        Json::Value::Members members = root.getMemberNames();
        for (Json::Value::Members::iterator iter = members.begin(); iter != members.end(); ++iter) {
            int key = std::atoi(iter->c_str());
            if (key < 0 || key > 255) continue;
            std::string val_str = root[*iter].asString();
            std::vector<std::string> rgb = StringSplit(val_str, ",");
            uint8_t r = std::atoi(rgb[0].c_str());
            uint8_t g = std::atoi(rgb[1].c_str());
            uint8_t b = std::atoi(rgb[2].c_str());
            adepallete[key * 3] = r;
            adepallete[key * 3 + 1] = g;
            adepallete[key * 3 + 2] = b;
        }
    }

    file.close();
}

}